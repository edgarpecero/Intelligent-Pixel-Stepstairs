<!doctype html>
<html>
<head>
    <title>Lümina Home</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" integrity="undefined" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/css/bootstrap4-toggle.min.css" rel="stylesheet">
    <link href="http://fonts.cdnfonts.com/css/space-ranger" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" href="main.css">
</head>


<body>
    <div id="progressbar"></div>
    <div id="scrollPath"></div>

    <div class="container">
        <div class="container-headliner">
            <div>

            </div>
            <div class="container-h1">
                <h1>escaleras inteligentes</h1>
            </div>
            <div class="container-h2">
                <h2>Lümina Leds</h2>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-4 col-lg-offset-4">
                <form>
                    <div class="container-programs">
                        <input type="radio" class="btn-check" name="options" id="sensor" autocomplete="off" checked>
                        <label class="btn btn-lg btn-success" for="sensor">Sensores</label>
                        <input type="radio" class="btn-check" name="options" id="effect" autocomplete="off">
                        <label class="btn btn-lg btn-success" for="effect">efectos</label>
                        <p> </p>
                    </div>
                    <div class="form-group">              <!--  // Get BoardUrl and Password to access to WebRepl -->
                        <label for="boardURL1">Nombre del Sistema</label>
                        <select class="form-control" id="boardURLID">
                        </select>
                        <!-- <input type="text" class="form-control" id="boardURL" value="ws://192.168.1.101:8266"> -->
                    </div>
                        <!-- <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" class="form-control" id="password" placeholder="Password">
                    </div> -->
                    <div class="form-group" id="div_s_animation">
                        <p> </p>
                        <label for="s_animation">Animaci&oacuten</label>
                        <select class="form-control" id="s_animation">
                            <option value="0">Escal&oacuten x escal&oacuten</option>
                            <option value="1">Llenado</option>
                        </select>
                    </div>
                    <div class="form-group" id="div_e_animation">
                        <p> </p>
                        <label for="e_animation">Animaci&oacuten</label>
                        <select class="form-control" id="e_animation">
                            <option value="chase">Perseguir</option>
                            <option value="smooth">Respiración</option>
                            <option value="jump">Saltos</option>
                            <option value="solid">S&oacutelido</option>
                            <option value="off">Apagado</option>
                        </select>
                    </div>
                    <div class="form-group" id="div_e_period_ms">
                        <label for="e_period_ms">Velocidad (1000 = 1 seg)</label>
                        <input type="text" class="form-control" id="e_period_ms" value="250">
                    </div>
                    <div class="form-group">
                        <label for="colors">Colores</label>
                        <select class="form-control" id="colors">
                        </select>
                    </div>
                    <div class="form-group" id="div_s_delay_step">
                        <label for="s_delay_step">Retardo Escalón (segundos)</label>
                        <input type="text" class="form-control" id="s_delay_step" value="10">
                    </div>
                    <div class="checkbox" id="div_e_mirror_colors">
                        <label>
                            <input type="checkbox" id="e_mirror_colors">efecto espejo
                        </label>
                    </div>
                    <div class="container-update">
                        <button class="btn btn-lg btn-primary" type="button" id="update">Actualizar</button>
                        <p></p>
                        <button type="button" class="btn btn-lg btn-danger" id="reset">Reset Programa</button>
                    </div>
                </form>
                <div class="social">
                    <h4>Síguenos en: </h4>
                    <a href="https://www.facebook.com/L%C3%BCmina-Leds-109159360992088"><i class="fa fa-facebook"></i> </a>
                    <a href="https://www.instagram.com/lumina_leds/"><i class="fa fa-instagram"></i> </a>
                    <!-- <a class="be" href="https://www.behance.net/edgarpecero"><i class="fab fa-behance-square"></i></a> -->
                </div>
                <p class="footer"><a href="https://luminaleds.mx">luminaleds.mx</a></p>

            </div>
            
        </div>
    </div>
    
</body>

<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.min.js" integrity="undefined" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script>
    let progress = document.getElementById('progressbar');
    let totalHeight = document.body.scrollHeight - window.innerHeight;
    window.onscroll = function(){
        let progressHeight = (window.pageYOffset / totalHeight) * 250;
        progress.style.height = progressHeight + "%";
    }
</script>

<script>
    $(document).ready(function(){
        //Main code called when pthe page loads
        //Starts on Sensor forms
        
        $('#div_e_animation').hide();
        $('#div_e_period_ms').hide();
        $('#div_e_mirror_colors').hide();
        $('#div_s_animation').hide();

        //Define list of boardURL(systems) the user can select to comunicate with
        var boardURLID = [
            { name: 'escalaras',            value: "ws://192.168.1.101:8266" },
            { name: 'entrada Principal',    value: "ws://192.168.1.101:8266" }
        ];
        //Define list of colors the user can select
        //solid colors or group of collors
        var colors = [
            { name: 'Blanco',        value: [[60,60,60], [0,0,0]] },
            { name: 'Amarillo',      value: [[80,40,0], [0,0,0]] },
            { name: 'Azul',          value: [[0,0,80], [0,0,0]] },
            { name: 'Cyan',          value: [[0,80,80], [0,0,0]] },
            { name: 'Naranja',       value: [[128,40,0], [0,0,0]] },
            { name: 'Oliva',         value: [[80,80,0], [0,0,0]] },
            { name: 'Rojo',          value: [[80,0,0], [0,0,0]] },
            { name: 'Verde',         value: [[0,80,0], [0,0,0]] },
            { name: 'Violeta',       value: [[80,0,80], [0,0,0]] },

            { name: 'Mexico',        value: [[80,80,80], [80,0,0], [0,80,0]] },
            { name: 'Azul - Rojo',   value: [[0,0,80], [16,0,128], [32,0,64], [64,0,32], [128,0,16], [80,0,0]] },
            { name: 'Rojo - Verde',  value: [[80,0,0], [128,16,0], [64,32,0], [32,64,0], [16,128,0], [0,80,0]] },
            { name: 'Azul - Blanco', value: [[0,0,80], [8,8,128], [16,16,128], [32,32,128], [64,64,128], [80,80,80]] }
        ];
        
        // Populate the color dropdown list with all the color and BoardURL options.
        // The value of each option is its index into the colors/boardURL list, and the name
        // is the nice printable name from the color/BoardURL list.
        boardURLID.forEach(function(boardURLID, i){
            $('#boardURLID').append($('<option></option>').attr('value', i).text(boardURLID.name));
        });
        colors.forEach(function(color, i){
            $('#colors').append($('<option></option>').attr('value', i).text(color.name));
        });
        // hide or show functions depending on the program selected.
        $('#sensor').click(function(){
            $('#div_e_animation').hide();
            $('#div_e_period_ms').hide();
            $('#div_e_mirror_colors').hide();
            $('#div_s_delay_step').show();
        });
        $('#effect').click(function(){
            $('#div_e_animation').show();
            $('#div_e_period_ms').show();
            $('#div_e_mirror_colors').show();
            $('#div_s_delay_step').hide();
        });

            // Attach a click handler to the update button.
            // This will use the web REPL as an 'API' to send a new configuration to
            // the board and save it as a config.json file.
        $('#update').click(function(){
            console.log('Update clicked Sensors!');
            // Grab the board URL (and password) from the page forms
            var boardURLx =  boardURLID[$('#boardURLID').val()].value;
            // var boardURL = $('#boardURL').val();
            // var password = $('#password').val();
   
            // Build a configuration object from the selected colors, program to upload,
            // animations, period, and other options.
            var config = {
                colors: colors[$('#colors').val()].value,   // Grab the color value array
                                                            // for the user's chosen color.
                e_animation: $('#e_animation').val(),
                e_period_ms: Number($('#e_period_ms').val()),
                e_mirror_colors: $('#e_mirror_colors').prop('checked'),
                mode_lights: $('#effect').prop('checked') ? 1 : 0 ,
                mode_sensors: $('#sensor').prop('checked') ? 1 : 0 ,
                s_animation: 0,
                // s_animation: Number($('#s_animation').val()),
                s_delay_step: Number($('#s_delay_step').val())*1000-2000,
                s_sensor_on: $('#sensor').prop('checked') ? 1 : 0
            };
            console.log(config)
            // Open an initialize web socker connection
            // ws = new WebSocket('ws://192.168.1.101:8266'); <<< Runing
            ws = new WebSocket(boardURLx);
            
            ws.onopen = function() {
                // Uncomment to see debug output of what was sent on the websocket
                // connection.
                //ws.onmessage = function(e) {
                //  console.log(e.data);
                //};
                // First send Password static or grabbed from HTML form.
                // ws.send(password + '\r\n');
                ws.send('1212\r\n');
                // Ctrl C to break out of any running loop.
                ws.send('\x03');
                // Conver configuration to JSON formatted data.
                console.log(config)
                var configJSON = JSON.stringify(config);
                var configUnit8Data = new Uint8Array(configJSON.length)
                for (var i = 0; i < configJSON.length; ++i){
                    configUnit8Data[i] = configJSON.charCodeAt(i);
                }
                // Create a put file request to save a new config.json file on the board
                var dest_fname = 'config.json';
                var dest_fsize = configUnit8Data.length;
                var rec = new Uint8Array(2 + 1 + 1 + 8 + 4 + 2 + 64);
                rec[0] = 'W'.charCodeAt(0);
                rec[1] = 'A'.charCodeAt(0);
                rec[2] = 1; // put
                rec[3] = 0;
                rec[4] = 0; rec[5] = 0; rec[6] = 0; rec[7] = 0; rec[8] = 0; rec[9] = 0; rec[10] = 0; rec[11] = 0;
                rec[12] = dest_fsize & 0xff; rec[13] = (dest_fsize >> 8) & 0xff; rec[14] = (dest_fsize >> 16) & 0xff; rec[15] = (dest_fsize >> 24) & 0xff;
                rec[16] = dest_fname.length & 0xff; rec[17] = (dest_fname.length >> 8) & 0xff;
                for (var i = 0; i < 64; ++i) {
                    if (i < dest_fname.length) {
                        rec[18 + i] = dest_fname.charCodeAt(i);
                    } else {
                        rec[18 + i] = 0;
                    }
                }
                // Send the put file request and file data.
                ws.send(rec);
                ws.send(configUnit8Data);
                console.log('sent the data!');
                // Reset the board (hard reset to make sure the web REPL restarts).
                // ws.send('import machine\r\nmachine.reset()\r\n');        // < Hard Reset
                ws.send('\x04');                                            // < Soft Reset
                // Close the websocket connection now that we're done.
                ws.close();
            };//$update.funcion.open
        });//$update.funcion

                // Attach a click handler to the reset button.
                // This will use the web REPL as an 'API' to send a Original configuration to
                // the board and save it as a config.json file.

                // Run Sensors program, set color white and use ntpserver.py function 
                // on Board to tracking time to turn on the sensors between 17:00 to 7:00.
        $('#reset').click(function(){
            $("divmirror").hide(); 
            console.log('Reseting...');
            var config = {
                colors: [[80,80,80], [0,0,0]],
                e_animation: $('#e_animation').val(),
                e_period_ms: Number($('#e_period_ms').val()),
                e_mirror_colors: $('#e_mirror_colors').prop('checked'),
                mode_lights: 0,
                mode_sensors: 1,
                s_animation: 0,
                // s_animation: Number($('#s_animation').val()),
                s_delay_step: 8000,
                s_sensor_on: 0
            };
            console.log(config)
            ws = new WebSocket('ws://192.168.1.101:8266');
            ws.onopen = function() {
                ws.send('1212\r\n');
                ws.send('\x03');
                var configJSON = JSON.stringify(config);
                var configUnit8Data = new Uint8Array(configJSON.length)
                for (var i = 0; i < configJSON.length; ++i){
                    configUnit8Data[i] = configJSON.charCodeAt(i);
                }
                var dest_fname = 'config.json';
                var dest_fsize = configUnit8Data.length;
                var rec = new Uint8Array(2 + 1 + 1 + 8 + 4 + 2 + 64);
                rec[0] = 'W'.charCodeAt(0);
                rec[1] = 'A'.charCodeAt(0);
                rec[2] = 1; // put
                rec[3] = 0;
                rec[4] = 0; rec[5] = 0; rec[6] = 0; rec[7] = 0; rec[8] = 0; rec[9] = 0; rec[10] = 0; rec[11] = 0;
                rec[12] = dest_fsize & 0xff; rec[13] = (dest_fsize >> 8) & 0xff; rec[14] = (dest_fsize >> 16) & 0xff; rec[15] = (dest_fsize >> 24) & 0xff;
                rec[16] = dest_fname.length & 0xff; rec[17] = (dest_fname.length >> 8) & 0xff;
                for (var i = 0; i < 64; ++i) {
                    if (i < dest_fname.length) {
                        rec[18 + i] = dest_fname.charCodeAt(i);
                    } else {
                        rec[18 + i] = 0;
                    }
                }
                ws.send(rec);
                ws.send(configUnit8Data);
                console.log('Sent Data!');
                ws.send('import machine\r\nmachine.reset()\r\n');
                };//$reset.function.open
                //location.reload();
            })//$reset.function
    });//$document

</script>

</html>
